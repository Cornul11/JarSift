package nl.tudelft.cornul11.thesis.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import nl.tudelft.cornul11.thesis.api.ApiClient;
import nl.tudelft.cornul11.thesis.model.MavenCoordinates;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class VulnerabilityService {

    private final ApiClient apiClient;
    private final ObjectMapper objectMapper = new ObjectMapper();

    public VulnerabilityService(ApiClient apiClient) {
        this.apiClient = apiClient;
    }

    public void checkForVulnerability(Map<String, Long> frequencyMap) throws IOException {
        DataTransformer dataTransformer = new DataTransformer();

        frequencyMap.forEach((key, value) -> {
            MavenCoordinates coordinate = dataTransformer.transform(key);

            // TODO: bring back the percentage calculation
//            double percentage = (value * 100.0) / classFileCount;
//            String percentageString = decimalFormat.format(percentage);

            // prepare the JSON data
            Map<String, Object> data = new HashMap<>();
            data.put("version", coordinate.getVersion());
            data.put("package", Map.of(
                    "name", coordinate.getGroupId() + ":" + coordinate.getArtifactId(),
                    "ecosystem", "Maven"
            ));

            String response = "{}";

            try {
                String jsonData = objectMapper.writeValueAsString(data);
                System.out.println("SENDING:");
                System.out.println(jsonData);
                System.out.println("GETTING:");
                String url = "https://api.osv.dev/v1/query";
                response = apiClient.makePostRequest(url, jsonData);
            } catch (IOException e) {
                System.out.println("Error during processing: " + e.getMessage());
            }

            String status = response.equals("{}") ? "✅" : "❌";
            String output = String.format("ArtifactId-Version: %s, Count: %d / d (s%%) %s",
                    key, value, /*classFileCount, percentageString,*/ status);

            System.out.println(output);

        });
    }
}