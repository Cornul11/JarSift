<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <style>
      .node {
        /* stroke: #fff;
        stroke-width: 1.5px; */
      }

      .link {
        stroke: #999;
        stroke-opacity: 0.3;
      }
    </style>
  </head>

  <body>
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="https://unpkg.com/netclustering/dist/netClustering.min.js"></script>
    <!-- <script type="text/javascript" src="../dist/netClustering.js"></script> -->
    <script>
      /* global d3, netClustering */

      const width = window.innerWidth,
        height = window.innerHeight;
      const graph = {
        nodes: [],
        links: [],
      };

      let zoom = d3.zoom().on("zoom", handleZoom);

      function handleZoom(e) {
        svg.attr("transform", e.transform);
      }

      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g");

      d3.json("miserables.json").then((data) => {
        const nodes = [];
        const links = [];
        const libIndex = {};
        graph.nodes = nodes;
        graph.links = links;

        const libs = new Set();
        let mainIndex = nodes.push({
          name: "main",
          group: 0,
          cluster: "blue",
        });
        for (let libName in data) {
          let index = nodes.push({
            name: libName,
            group: data[libName].length,
            cluster: "green",
          });
          for (let artifact of data[libName]) {
            if (!libs.has(artifact)) {
              libs.add(artifact);
              libIndex[artifact] = nodes.push({
                name: artifact,
                group: 4,
                cluster: "black",
              });
              links.push({
                source: mainIndex - 1,
                target: libIndex[artifact] - 1,
                value: 1,
                class: "main",
              });
            }
            links.push({
              source: index - 1,
              target: libIndex[artifact] - 1,
              value: 10,
              distance: 0,
              class: "lib",
            });
          }
        }
        const simulation = d3
          .forceSimulation(nodes)
          .force("x", d3.forceX(width / 2).strength(0.6))
          .force("y", d3.forceY(height / 2).strength(0.6))
          .force("charge", d3.forceManyBody())
          // .force("center", d3.forceCenter(width / 2, height / 2))
          .force("link", d3.forceLink(links))
          .velocityDecay(0.1);

        setTimeout(() => {
          simulation.stop();
          // link
          //   .join("line")
          //   .style("stroke-width", function (d) {
          //     if (d.class === "main") {
          //       return 0;
          //     }
          //     return "1px";
          //   })
          //   .attr("class", "link");
        }, 30000);

        const link = svg.selectAll(".link").data(graph.links);

        const node = svg
          .selectAll(".node")
          .data(graph.nodes)
          .join("circle")
          .attr("class", "node")
          .style("stroke", function (d) {
            return 0;
          })
          .style("fill", function (d) {
            return d.cluster;
          })
          .attr("r", function (d) {
            return Math.log(d.group);
          });
        // .call(simulation.drag);

        d3.select("svg").call(
          d3.zoom().on("zoom", function () {
            svg.attr("transform", d3.zoomTransform(this));
          })
        );

        node.append("title").text(function (d) {
          return d.name;
        });

        simulation.on("tick", function () {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);
          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
        });
      });
    </script>
  </body>
</html>
